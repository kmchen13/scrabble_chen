#!/bin/bash

# VÃ©rifie que jq est installÃ©
if ! command -v jq &> /dev/null; then
  echo "âŒ Erreur : 'jq' n'est pas installÃ©. Installe-le avec : sudo apt install jq"
  exit 1
fi

# Relance adb pour Ã©liminer tous zombies
adb kill-server
adb start-server
adb devices

# RÃ©cupÃ¨re les 2 premiers IDs des devices Android (arm et arm64)
devices=($(flutter devices --machine | jq -r '.[] | select(.targetPlatform == "android-arm" or .targetPlatform == "android-arm64") | .id'))

if [ ${#devices[@]} -lt 2 ]; then
  echo "âŒ Moins de 2 appareils dÃ©tectÃ©s. Branche-les puis rÃ©essaie."
  flutter devices
  exit 1
fi

echo "ğŸ“± Appareil 1 : ${devices[0]}"
echo "ğŸ“± Appareil 2 : ${devices[1]}"
echo "ğŸš€ Compilation unique de lâ€™APK..."

# Compile une fois le debug APK
flutter build apk --debug

APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"

if [ ! -f "$APK_PATH" ]; then
  echo "âŒ APK introuvable Ã  $APK_PATH"
  exit 1
fi

echo "ğŸ“² Installation et lancement sur les appareils..."

for device in "${devices[@]:0:2}"; do
  echo "â¡ï¸ Device $device : installation"
  adb -s "$device" install -r "$APK_PATH"

  echo "â¡ï¸ Device $device : lancement de l'app"
  # Remplace com.example.scrabble_chen/.MainActivity par ton package et activity Flutter
  adb -s "$device" shell am start -n com.example.scrabble_chen/.MainActivity
done

echo "âœ… App lancÃ©e sur les 2 appareils."

# Ouvre Konsole avec un onglet par device pour logs adb logcat
for device in "${devices[@]:0:2}"; do
konsole --new-tab -e bash -c "flutter run -d $devices --no-hot; echo 'TerminÃ© â€” appuyez sur q pour quitter'; while true; do read -n 1 key; if [[ \$key == q ]]; then break; fi; done" &

done


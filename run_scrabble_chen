#!/bin/bash

# V√©rifie que jq est install√©
if ! command -v jq &> /dev/null; then
  echo "‚ùå Erreur : 'jq' n'est pas install√©. Installe-le avec : sudo apt install jq"
  exit 1
fi

# Relance adb pour √©liminer tous zombies
adb kill-server
adb start-server
adb devices

# R√©cup√®re les 2 premiers IDs des devices Android (arm et arm64)
devices=($(flutter devices --machine | jq -r '.[] | select(.targetPlatform == "android-arm" or .targetPlatform == "android-arm64") | .id'))

if [ ${#devices[@]} -lt 2 ]; then
  echo "‚ùå Moins de 2 appareils d√©tect√©s. Branche-les puis r√©essaie."
  flutter devices
  exit 1
fi


if [[ $1 == "-"*"c"* ]]
then
	# Compile une fois le debug APK
	flutter build apk --debug

	APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"

	if [ ! -f "$APK_PATH" ]; then
	  echo "‚ùå APK introuvable √† $APK_PATH"
	  exit 1
	fi

	echo "üì≤ Installation sur les appareils..."

	for device in "${devices[@]:0:2}"; do
	  echo "‚û°Ô∏è Device $device : installation"
	  adb -s "$device" install -r "$APK_PATH"

	  echo "‚û°Ô∏è Device $device : lancement de l'app"
	  # Remplace com.example.scrabble_chen/.MainActivity par ton package et activity Flutter
	  adb -s "$device" shell am start -n com.example.scrabble_chen/.MainActivity
	done
fi

echo "‚úÖ App lancement sur les 2 appareils."

# Ouvre Konsole avec un onglet par device pour logs adb logcat
for device in "${devices[@]:0:2}"; do
	echo "lancement $device"
	konsole --new-tab -e bash -c "flutter run -d $device --no-hot; echo 'Termin√© ‚Äî appuyez sur q pour quitter'; while true; do read -n 1 key; if [[ \$key == q ]]; then break; fi; done" &
#	konsole --new-tab -e bash -c "flutter run -d $device;" &
done

